/* Copyright 2020 Ben Roesner (keycapsss.com)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#include QMK_KEYBOARD_H
#include <stdio.h>
#include <string.h>

char wpm_str[10];
int selected_layer = 0;
int layer_count = 3; // Max Array ID, so count - 1
char *layer_string;

char *repeatStr (char *str, size_t count) {
    if (count == 0) return NULL;
    char *ret = malloc (strlen (str) * count + count);
    if (ret == NULL) return NULL;
    strcpy (ret, str);
    while (--count > 0) {
        strcat (ret, " ");
        strcat (ret, str);
    }
    return ret;
}

enum layers {
    _NUMPAD,
    _DISCORD,
    _MEDIA,
    _MIDI,
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
/*
 * ,-----------------------,
 * |     |     |     |MUTE |
 * |-----+-----+-----+-----|
 * |  7  |  8  |  9  |  -  |
 * |-----+-----+-----+-----|
 * |  4  |  5  |  6  |  +  |
 * |-----+-----+-----+-----|
 * |  1  |  2  |  3  |  0  |
 * `-----------------------'
 */
    [_NUMPAD] = LAYOUT_ortho_4x4(
        _______,   _______,  _______,   KC_KP_0,
        KC_KP_7,   KC_KP_8,  KC_KP_9,   KC_KP_MINUS,
        KC_KP_4,   KC_KP_5,  KC_KP_6,   KC_KP_PLUS,
        KC_KP_1,   KC_KP_2,  KC_KP_3,   KC_KP_0
    ),
/*
 * ,-----------------------,
 * |     |     |     |MUTE |
 * |-----+-----+-----+-----|
 * |  7  |  8  |  9  |  -  |
 * |-----+-----+-----+-----|
 * |  4  |  5  |  6  |  +  |
 * |-----+-----+-----+-----|
 * |  1  |  2  |  3  |  0  |
 * `-----------------------'
 */
    [_DISCORD] = LAYOUT_ortho_4x4(
        _______,   _______,  _______,   KC_KP_1,
        KC_KP_7,   KC_KP_8,  KC_KP_9,   KC_KP_MINUS,
        KC_KP_4,   KC_KP_5,  KC_KP_6,   KC_KP_PLUS,
        KC_KP_1,   KC_KP_2,  KC_KP_3,   KC_KP_0
    ),
/*
 * ,-----------------------,
 * |     |     |     |MUTE |
 * |-----+-----+-----+-----|
 * |  7  |  8  |  9  |  -  |
 * |-----+-----+-----+-----|
 * |  4  |  5  |  6  |  +  |
 * |-----+-----+-----+-----|
 * |  1  |  2  |  3  |  0  |
 * `-----------------------'
 */
    [_MEDIA] = LAYOUT_ortho_4x4(
        _______,   _______,  _______,   KC_KP_2,
        KC_KP_7,   KC_KP_8,  KC_KP_9,   KC_KP_MINUS,
        KC_KP_4,   KC_KP_5,  KC_KP_6,   KC_KP_PLUS,
        KC_KP_1,   KC_KP_2,  KC_KP_3,   KC_KP_0
    ),
/*
 * ,-----------------------,
 * |     |     |     |MUTE |
 * |-----+-----+-----+-----|
 * |  7  |  8  |  9  |  -  |
 * |-----+-----+-----+-----|
 * |  4  |  5  |  6  |  +  |
 * |-----+-----+-----+-----|
 * |  1  |  2  |  3  |  0  |
 * `-----------------------'
 */
    [_MIDI] = LAYOUT_ortho_4x4(
        _______,   _______,  _______,   KC_KP_3,
        KC_KP_7,   KC_KP_8,  KC_KP_9,   KC_KP_MINUS,
        KC_KP_4,   KC_KP_5,  KC_KP_6,   KC_KP_PLUS,
        KC_KP_1,   KC_KP_2,  KC_KP_3,   KC_KP_0
    ),


};

void encoder_update_user(uint8_t index, bool clockwise) {
/*
Rev3 isp
,-----------------------,
|     |     |     | E4  |
|-----+-----+-----+-----|
|     |     |     |     |
|-----+-----+-----+-----|
|     |     |     |     |
|-----+-----+-----+-----|
|     |     |     |     |
`-----------------------'
*/
    if (index == 3) {
        if (clockwise && selected_layer < layer_count) {
            selected_layer++;
        } else if(clockwise && selected_layer == layer_count) {
            selected_layer = 0;
        } else if (!clockwise && selected_layer > 0) {
            selected_layer--;
        } else if (!clockwise && selected_layer == 0) {
            selected_layer = layer_count;
        }
        layer_clear();
        layer_on(selected_layer);
    }
}

#ifdef OLED_DRIVER_ENABLE

oled_rotation_t oled_init_user(oled_rotation_t rotation) {
    return OLED_ROTATION_0;
}

#undef OLED_FONT_WIDTH
#undef OLED_FONT_HEIGHT
#define OLED_FONT_WIDTH 8 //still doesn't work
#define OLED_FONT_HEIGHT 16

// WPM-responsive animation stuff here
#define IDLE_FRAMES 5
#define IDLE_SPEED 40 // below this wpm value your animation will idle

// #define PREP_FRAMES 1 // uncomment if >1

#define TAP_FRAMES 2
#define TAP_SPEED 60 // above this wpm value typing animation to triggere

#define ANIM_FRAME_DURATION 200 // how long each frame lasts in ms
// #define SLEEP_TIMER 60000 // should sleep after this period of 0 wpm, needs fixing
#define ANIM_SIZE 636 // number of bytes in array, minimize for adequate firmware size, max is 1024

uint32_t anim_timer = 0;
uint32_t anim_sleep = 0;
uint8_t current_idle_frame = 0;
// uint8_t current_prep_frame = 0; // uncomment if PREP_FRAMES >1
uint8_t current_tap_frame = 0;

void render_bongo_logo(void) {
    static const char PROGMEM bongo_logo[] = {
    // 'bongocat64', 64x32px with empty right side of 64x width
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0x78, 0x06, 0x01, 0x01, 0x02, 0x04, 0x08, 0x18, 0x18, 0x18, 0x18,
    0x18, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x40, 0x60, 0x60, 0x60, 0x60, 0x80, 0x80, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x30, 0xf0, 0x08, 0x04, 0x04, 0x04, 0x04, 0x08, 0x10, 0x60, 0x90, 0x18,
    0x0c, 0x06, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x01, 0x01, 0x02, 0x02, 0x01, 0x01, 0x00, 0x00, 0x87, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0x80, 0x80, 0x80, 0x81, 0x03, 0x1c, 0x60, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, 0x08, 0x18, 0x10, 0x10, 0x10,
    0x08, 0x10, 0x20, 0x20, 0x20, 0x10, 0x10, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0xe0, 0x10, 0x08,
    0x08, 0x08, 0x08, 0x08, 0x10, 0x20, 0xc0, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02,
    0x02, 0x02, 0x06, 0x0c, 0x04, 0x04, 0x04, 0x0c, 0x04, 0x04, 0x08, 0x18, 0x18, 0x18, 0x18, 0x18,
    0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x40, 0x60, 0x60, 0x60, 0x60, 0x43, 0x7c, 0xe0,
    0xc0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x03, 0x00, 0x00, 0x01, 0x3e, 0xc0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
    oled_write_raw_P(bongo_logo, sizeof(bongo_logo));
}

void render_default_layer_state(void) {
    switch (get_highest_layer(layer_state)) {
        case _NUMPAD:
            oled_write_ln_P(PSTR("¤"), false);
            oled_write_ln_P(PSTR("NUMPAD"), false);
            break;
        case _DISCORD:
            oled_write_ln_P(PSTR("¤¤"), false);
            oled_write_ln_P(PSTR("DISCORD"), false);
            break;
        case _MEDIA:
            oled_write_ln_P(PSTR("¤¤¤"), false);
            oled_write_ln_P(PSTR("MEDIA"), false);
            break;
        case _MIDI:
            oled_write_ln_P(PSTR("¤¤¤¤"), false);
            oled_write_ln_P(PSTR("MIDI"), false);
            break;
        default:
            oled_write_ln_P(PSTR("----////----"), false);
            oled_write_ln_P(PSTR("Undefined"), false);
    }
}

void oled_task_user(void) {
    render_default_layer_state();
    //oled_set_cursor(12,0);
    //render_bongo_logo();
}

#endif // OLED_DRIVER_ENABLE
